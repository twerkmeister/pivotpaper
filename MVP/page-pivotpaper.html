<link rel="import" href="./components/polymer/polymer.html">
<link rel="import" href="article-service.html">
<link rel="import" href="article-list.html"/>

<polymer-element name="page-pivotpaper">
    <template>
        <style>

            span.line {
                display: inline-block;
            }
            #chart {
                height: 400px;
                max-height: 30vh;
                width: 100%;
                /*min-height: 400px;*/
            }

            #chart canvas {
                height: 100% !important;
                width: 100% !important;
            }

            #list {
                width: 100%;
            }
            #status {
                font-size: 14px;
                color: #6C6C6C;
                margin: 0 20px 0 20px;
                text-align: center;
            }
            @media (min-width: 481px) {
                .container {
                width: 90%;
                margin: auto;
            }

                #status {
                    font-size: 24px;
                }
             }
        </style>
        <article-service id="service" hotness="{{hotness}}" articles="{{articles}}" url="entries.json"></article-service>
        <section class="container" layout vertical center>
            <h2>Explore the Greek Financial Crisis over the course of time</h2>
            <div id="chart">
                <canvas id="canvas" style="height: 100%; width: 100%;"/>
            </div>
            <p id="status">
                <span class="line">{{statusText1}}</span>
                <span class="line">{{statusText2}}</span>
            </p>
            <div id="list">
                <article-list id="articleList" articles="{{articles}}"></article-list>
            </div>
        </section>
    </template>
    <script>
        Polymer('page-pivotpaper', {
            publish: {
                date: Date.now(),
                articles: [],
                dateRange: 0,
                statusText1: "",
                statusText2: ""
            },
            create: function() {
                
            },
            ready: function () {
                $.getJSON('testData.json', function (result) {
                    this.statusText1 = "Select a time frame between two years to start.";
                    var cv = this.$.canvas;
                    var ctx = cv.getContext('2d');
                    //calc the labels for the chart
                    var chartLabels = [];
                    var chartData = [];
                    var iterator = 0;
                    for (var i = 0; i < result.length; i++) {
                        var date = new Date(result[i].date);
                        chartLabels.push(date.getUTCFullYear());
                        chartData.push(result[i].value);
                    }
                    console.log(chartLabels);
                    console.log(chartData);

                    var chartDataObject = {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: "My First dataset",
                                fillColor: "rgba(65, 105, 225,0.2)",
                                strokeColor: "rgba(65, 105, 225, 1)",
                                pointColor: "rgba(65, 105, 225, 1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(220,220,220,1)",
                                data: chartData
                            }
                        ]
                    };
                    var pointSelectionRadius = (0.95 * cv.offsetWidth) / chartData.length;
                    var options = {
                        ///Boolean - Whether grid lines are shown across the chart
                        scaleShowGridLines: true,
                        //String - Colour of the grid lines
                        scaleGridLineColor: "rgba(0,0,0,.05)",
                        //Number - Width of the grid lines
                        scaleGridLineWidth: 1,
                        //Boolean - Whether to show horizontal lines (except X axis)
                        scaleShowHorizontalLines: true,
                        //Boolean - Whether to show vertical lines (except Y axis)
                        scaleShowVerticalLines: true,
                        //Boolean - Whether the line is curved between points
                        bezierCurve: true,
                        //Number - Tension of the bezier curve between points
                        bezierCurveTension: 0.3,
                        //Boolean - Whether to show a dot for each point
                        pointDot: true,
                        //Number - Radius of each point dot in pixels
                        pointDotRadius: 4,
                        //Number - Pixel width of point dot stroke
                        pointDotStrokeWidth: 1,
                        //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
                        pointHitDetectionRadius: pointSelectionRadius,
                        //Boolean - Whether to show a stroke for datasets
                        datasetStroke: true,
                        //Number - Pixel width of dataset stroke
                        datasetStrokeWidth: 2,
                        //Boolean - Whether to fill the dataset with a colour
                        datasetFill: true,
                        // Boolean - Determines whether to draw tooltips on the canvas or not
                        showTooltips: true,
                        customTooltips: function() {},
                        //String - A legend template
                        legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>",
                        // Boolean - whether or not the chart should be responsive and resize when the browser does.
                        responsive: true,
                        // Boolean - whether to maintain the starting aspect ratio or not when responsive, if set to false, will take up entire container
                        maintainAspectRatio: false
                    };
                    var myLineChart = new Chart(ctx).Line(chartDataObject, options);
                    document.vieModel = {
                        chart: myLineChart,
                        hotData: result
                    }
                    cv.onclick = function(evt) {
                        var activePoints = myLineChart.getPointsAtEvent(evt);
                        console.log(activePoints);
                        var year = 0;
                        if (activePoints.length > 0) {
                            var date1 = parseInt(activePoints[0].label);
                            var date2 = parseInt(activePoints[activePoints.length - 1].label);
                            if (date1 <= 0 || date2 <= 0) return;
                            date1 = new Date(date1, 0);
                            if (activePoints.length > 1) {
                                date2 = new Date(date2, 0);
                            } else {
                                //if exactly one year is selected, set endDate to end of this year
                                date2 = new Date(date2 + 1, 0);
                            }
                            this.$.articleList.startDate = date1;
                            this.$.articleList.endDate = date2;
                            this.statusText1 = "articles\xA0starting\xA0from";
                            this.statusText2 = date1.toString('d-MMM-yyyy') + "\xA0to\xA0" + date2.toString('d-MMM-yyyy');
                        }
                    }.bind(this);
                }.bind(this));
            }
        });
    </script>
</polymer-element>
