<link rel="import" href="./components/polymer/polymer.html">
<link rel="import" href="article-service.html">
<link rel="import" href="article-list.html"/>

<polymer-element name="page-pivotpaper">
    <template>
        <style>
            span.line {
                display: inline-block;
            }
            #chart {
                position: relative;
                height: 400px;
                max-height: 30vh;
                width: 100%;
                /*min-height: 400px;*/
            }

            #canvas {
                position: relative;
                /*height: 100% !important;
                width: 100% !important;*/
                z-index: 10;
            }

            #selCanvas {
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                /*height: 100% !important;
                width: 100% !important;*/
                z-index: 1;
            } 

            #list {
                width: 100%;
            }
            #status {
                font-size: 14px;
                color: #6C6C6C;
                margin: 0 20px 0 20px;
                text-align: center;
            }
             @media (min-width: 481px) {
                .container {
                    width: 75%;
                    margin: auto;
                }

                #status {
                    font-size: 24px;
                }
             }
             .rotate {
                -webkit-transform: rotate(-90deg);
                -moz-transform: rotate(-90deg);
                -ms-transform: rotate(-90deg);
                -o-transform: rotate(-90deg);
                transform: rotate(-90deg);

                /* also accepts left, right, top, bottom coordinates; not required, but a good idea for styling */
                -webkit-transform-origin: 50% 50%;
                -moz-transform-origin: 50% 50%;
                -ms-transform-origin: 50% 50%;
                -o-transform-origin: 50% 50%;
                transform-origin: 50% 50%;

                /* Should be unset in IE9+ I think. */
                filter: progid:DXImageTransform.Microsoft.BasicImage(rotation=3);
            }
            #achseDesrc {
                position: absolute;
                top: 47px;
                left: -60px;
                color: #6C6C6C;
            }
        </style>
        <article-service id="service" hotness="{{hotness}}" articles="{{articles}}" url="" urllocal=""></article-service>
        <section class="container" layout vertical center>
            <h2>Explore the Greek Financial Crisis over the course of time</h2>
            <div id="chart">
                <div class="rotate" id="achseDesrc">Hotness Index</div>
                <canvas id="selCanvas"></canvas>
                <canvas id="canvas" style="height: 100%; width: 100%;"/>
            </div>
            <p id="status">
                <span class="line">{{statusText1}}</span>
                <span class="line">{{statusText2}}</span>
            </p>
            <div id="list">
                <article-list id="articleList" articles="{{articles}}"></article-list>
            </div>
        </section>
    </template>
    <script>
        Polymer('page-pivotpaper', {
            publish: {
                date: Date.now(),
                articles: [],
                dateRange: 0,
                statusText1: "",
                statusText2: "",
                vMilestone: false
                
            },
            create: function () {
                
            },
            ready: function () {
                if (this.vMilestone) {
                    this.$.service.url = "https://cdn.contentful.com/spaces/ksm7j35bqdb4/entries?content_type=1QQBcDtafaUEQSWuOGac4u&access_token=5bd02d9b007e1279c03ab3d898777261ad38f9485c526f2c09430337014a6569";
                    this.$.service.urlLocal = "mileEntries.json";
                } else {
                    this.$.service.url = "https://cdn.contentful.com/spaces/ksm7j35bqdb4/entries?content_type=1QQBcDtafaUEQSWuOGac4u&access_token=5bd02d9b007e1279c03ab3d898777261ad38f9485c526f2c09430337014a6569";
                    this.$.service.urlLocal = "yearEntries.json";
                }
                this.$.service.go();
                var graphURL = this.vMilestone ? 'mileData.json' : 'yearData.json';
                $.getJSON(graphURL, function (result) {
                    this.statusText1 = "Select a time frame between two years to start.";

                    this.fitToContainer = function(canvas) {
                        // Make it visually fill the positioned parent
                        canvas.style.width = '100%';
                        canvas.style.height = '100%';
                        // ...then set the internal size to match
                        canvas.width = canvas.offsetWidth;
                        canvas.height = canvas.offsetHeight;
                    }

                    window.addEventListener("resize", function() {
                        this.fitToContainer(this.$.selCanvas);
                    }.bind(this));
                    this.fitToContainer(this.$.selCanvas);
                    var cv = this.$.canvas;
                    var ctx = cv.getContext('2d');
                    //calc the labels for the chart
                    var chartLabels = [];
                    var chartData = [];
                    var date;
                    var iterator;
                    if (!this.vMilestone) {
                        iterator = 0;
                        for (var i = 0; i < result.length; i++) {
                            date = new Date(result[i].date);
                            chartLabels.push(date.getUTCFullYear());
                            chartData.push(result[i].value);
                        }
                    } else {
                        iterator = 0;
                        for (var i = 0; i < result.length; i++) {
                            date = result[i].date;
                            chartLabels.push(date);
                            chartData.push(result[i].value);
                        }
                    }
                    console.log(chartLabels);
                    console.log(chartData);

                    var chartDataObject = {
                        labels: chartLabels,
                        datasets: [
                            {
                                label: "My First dataset",
                                fillColor: "rgba(65, 105, 225,0.2)",
                                strokeColor: "rgba(65, 105, 225, 1)",
                                pointColor: "rgba(65, 105, 225, 1)",
                                pointStrokeColor: "#fff",
                                pointHighlightFill: "#fff",
                                pointHighlightStroke: "rgba(220,220,220,1)",
                                data: chartData
                            }
                        ]
                    };
                    var pointSelectionRadius;
                    //on Milestone view I only want to select single nodes
                    if (this.vMilestone) {
                        pointSelectionRadius = (0.3 * cv.offsetWidth) / chartData.length;
                    } else {
                        pointSelectionRadius = (0.95 * cv.offsetWidth) / chartData.length;
                    }
                    var options = {
                        ///Boolean - Whether grid lines are shown across the chart
                        scaleShowGridLines: true,
                        //String - Colour of the grid lines
                        scaleGridLineColor: "rgba(0,0,0,.05)",
                        //Number - Width of the grid lines
                        scaleGridLineWidth: 1,
                        //Boolean - Whether to show horizontal lines (except X axis)
                        scaleShowHorizontalLines: true,
                        //Boolean - Whether to show vertical lines (except Y axis)
                        scaleShowVerticalLines: true,
                        //Boolean - Whether the line is curved between points
                        bezierCurve: true,
                        //Number - Tension of the bezier curve between points
                        bezierCurveTension: 0.3,
                        //Boolean - Whether to show a dot for each point
                        pointDot: true,
                        //Number - Radius of each point dot in pixels
                        pointDotRadius: 4,
                        //Number - Pixel width of point dot stroke
                        pointDotStrokeWidth: 1,
                        //Number - amount extra to add to the radius to cater for hit detection outside the drawn point
                        pointHitDetectionRadius: pointSelectionRadius,
                        //Boolean - Whether to show a stroke for datasets
                        datasetStroke: true,
                        //Number - Pixel width of dataset stroke
                        datasetStrokeWidth: 2,
                        //Boolean - Whether to fill the dataset with a colour
                        datasetFill: true,
                        // Boolean - Determines whether to draw tooltips on the canvas or not
                        showTooltips: true,
                        customTooltips: function() {},
                        //String - A legend template
                        legendTemplate: "<ul class=\"<%=name.toLowerCase()%>-legend\"><% for (var i=0; i<datasets.length; i++){%><li><span style=\"background-color:<%=datasets[i].strokeColor%>\"></span><%if(datasets[i].label){%><%=datasets[i].label%><%}%></li><%}%></ul>",
                        // Boolean - whether or not the chart should be responsive and resize when the browser does.
                        responsive: true,
                        // Boolean - whether to maintain the starting aspect ratio or not when responsive, if set to false, will take up entire container
                        maintainAspectRatio: false
                    };
                    var myLineChart = new Chart(ctx).Line(chartDataObject, options);
                    document.vieModel = {
                        chart: myLineChart,    
                        hotData: result
                    }
                    cv.onclick = function(evt) {
                        var activePoints = myLineChart.getPointsAtEvent(evt);
                        console.log(activePoints);
                        var year = 0;
                        if (activePoints.length > 0) {
                            var selX, selX2 = 0;
                            this.$.articleList.showIntro = false;
                            if (!this.vMilestone) {
                                var date1 = parseInt(activePoints[0].label);
                                var date2 = parseInt(activePoints[activePoints.length - 1].label);
                                if (date1 <= 0 || date2 <= 0) return;
                                date1 = new Date(date1, 0);
                                if (activePoints.length > 1) {
                                    date2 = new Date(date2, 0);
                                } else {
                                    //if exactly one year is selected, set endDate to end of this year
                                    date2 = new Date(date2 + 1, 0);
                                }
                                this.$.articleList.startDate = date1;
                                this.$.articleList.endDate = date2;
                                this.statusText1 = "";
                                //this.statusText1 = "articles\xA0starting\xA0from";
                                //this.statusText2 = date1.toString('d-MMM-yyyy') + "\xA0to\xA0" + date2.toString('d-MMM-yyyy');
                                selX = activePoints[0].x;
                                selX2 = activePoints[activePoints.length - 1].x - activePoints[0].x;
                                ga('send', 'event', 'year', 'click', date1.getUTCFullYear());
                            } else {
                                for (var i = 0; i < activePoints.length; i++) {
                                    if (activePoints[i].label.indexOf("#") >= 0) {
                                        var milestoneNr = parseInt(activePoints[i].label[1]);
                                        var startYear, endYear;
                                        switch (milestoneNr) {
                                        case 1:
                                            startYear = new Date(1999, 0);
                                            endYear = new Date(2001, 0);
                                            break;
                                        case 2:
                                            startYear = new Date(2001, 0);
                                            endYear = new Date(2009, 0);
                                            break;
                                        case 3:
                                            startYear = new Date(2009, 0);
                                            endYear = new Date(2009, 12);
                                            break;
                                        case 4:
                                            startYear = new Date(2009, 12);
                                            endYear = new Date(2010, 0);
                                            break;
                                        case 5:
                                            startYear = new Date(2010, 0);
                                            endYear = new Date(2012, 0);
                                            break;
                                        case 6:
                                            startYear = new Date(2012, 0);
                                            endYear = new Date(2015, 0);
                                            break;
                                        case 7:
                                            startYear = new Date(2015, 0);
                                            endYear = new Date(2015, 12);
                                            break;
                                        }
                                        this.$.articleList.startDate = startYear;
                                        this.$.articleList.endDate = endYear;
                                        this.statusText1 = "articles\xA0related\xA0to\xA0";
                                        this.statusText2 = activePoints[i].label;
                                        selX = activePoints[0].x;
                                        selX2 = activePoints[activePoints.length - 1].x - activePoints[0].x;
                                        ga('send', 'event', 'year', 'click', startYear.getUTCFullYear());
                                    }
                                }
                            }

                            //draw the seletion rect
                            var canvas = this.$.selCanvas;
                            var ctx = canvas.getContext('2d');
                            ctx.clearRect(0, 0, canvas.width, canvas.height);

                            var grd = ctx.createLinearGradient(0, 0, 0, canvas.height);
                            // light blue
                            grd.addColorStop(0, "rgba(255,194,108,1)");
                            // dark blue
                            grd.addColorStop(1, "rgba(255,194,108,0)");
                            ctx.fillStyle = grd;
                            ctx.fillRect(selX,0,selX2, canvas.height);
                            console.log(activePoints);
                        }
                    }.bind(this);
                }.bind(this));
            }
        });
    </script>
</polymer-element>
